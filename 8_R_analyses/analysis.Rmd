---
title: "Genomics & Habitat Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```
```{r}

library(tidyverse)
library(readxl)
library(ggplot2)

traits <- read_excel('data2/bird_GD_lifehistory_71species_22022020.xlsx',
                      sheet='Table S1 lifehistory') %>%
  rename(Species=Genus_Species) %>%
  rename(IUCN = GlobalIUCNRedListCategory) %>%
  mutate(IUCN = factor(IUCN, levels=c('LC','NT','VU','EN','CR'))) %>% 
  select(Species, threatenedNonthreatened, Diet_5Cat, 
         adultBodyMassGram, flyingOrNot, litterOrClutchSizeNumber,
  movementPatterns,IUCN)

areas <- read_csv('data2/enm_areas.csv')
chng <- read_csv('data2/enm_change.csv')
nesize <- read_csv('data2/ne_size.csv')
nechng <- read_csv('data2/ne_change.csv')

gen <- read_excel('data2/bird_GD_lifehistory_71species_22022020.xlsx',
                      sheet='Table S3 GD') %>%
  select(Species, `heterozygosity_for_autosomes_>10k_bp`)

names(gen) <- c('Species', 'Het')

dat <- data.frame(traits, Het=gen$Het) %>% as_tibble()

dat <- dat %>%
  #left_join(traits, by='Species') %>%
  mutate(threatened=ifelse(threatenedNonthreatened=="NT", 0, 1)) %>%
  mutate(mass = as.numeric(adultBodyMassGram)) %>%
  mutate(diet = relevel(as.factor(Diet_5Cat), ref='VertFishScav')) %>%
  mutate(litter = as.numeric(litterOrClutchSizeNumber)) %>%
  mutate(carn = ifelse(Diet_5Cat=='VertFishScav','Carnivore','Non-carnivore')) %>%
  mutate(carn=factor(carn, levels=c('Non-carnivore','Carnivore'))) %>%
  mutate(migrates=ifelse(movementPatterns=='non-migrant',0,1))

lat <- read_csv('data2/mean_lat.csv') %>%
  rename(Species=SCINAME) %>%
  mutate(Species=gsub(" ", "_", Species))

dat_lat <- dat %>%
  left_join(lat, by='Species')
```

## Heterozygosity

I modeled heterozygosity as a function of threatened status, mass, diet, 
and migration status.

```{r}

dat_het <- dat_lat %>%
  left_join(areas %>% rename(area=present, Species=species) %>% select(Species,area))

mod <- lm(log(Het) ~ threatened + scale(mass) + migrates + diet + 
          scale(mean_lat) + scale(area), data=dat_het)

sjPlot::tab_model(mod)
```

### Mass

```{r}

df_temp <- data.frame(threatened=0, mass=0, migrates=0, 
                      diet=factor('VertFishScav', levels=levels(dat_het$diet)), mean_lat=0,
                      area=0,IUCN='LC')

mass_sc <- dat_het$mass#scale(dat_het$mass)
mass_seq <- seq(range(mass_sc)[1],range(mass_sc)[2], length.out=1000)

actual_seq <- seq(range(dat_het$mass)[1], range(dat_het$mass)[2], length.out=1000)

nd <- df_temp
nd <- nd[rep(1,1000),]
nd$mass <- mass_seq
pr <- predict(mod, newdata=nd, se.fit=T)

mytheme <-   theme_bw() +
  theme(panel.grid.major=element_blank(), panel.grid.minor=element_blank(),
  axis.text=element_text(size=14), axis.title=element_text(size=16))

data.frame(pr=pr$fit, lower=pr$fit - 1.96*pr$se.fit, 
           upper=pr$fit + 1.96*pr$se.fit, mass=actual_seq) %>%
  ggplot(aes(x=mass/1000, y=pr)) +
  geom_ribbon(aes(ymin=lower,ymax=upper), alpha=0.4) +
  geom_line() +
  labs(x='Mass (kg)', y='log(H)') +
  mytheme
```

### Diet

```{r}
nd <- df_temp[rep(1,length(levels(dat_het$diet))),]
nd$diet <- levels(dat_het$diet)

pr <- predict(mod, newdata=nd, se.fit=T)

data.frame(pr=pr$fit, lower=pr$fit - 1.96*pr$se.fit, 
           upper=pr$fit + 1.96*pr$se.fit,
           diet=nd$diet) %>%
  ggplot(aes(x=diet, y=pr)) +
  geom_errorbar(aes(ymin=lower,ymax=upper), width=0.4) +
  geom_point() +
  labs(y='log(H)')  +
  mytheme +
  theme(axis.title.x=element_blank())
```


### Migration Status

```{r}
nd <- df_temp[rep(1,2),]
nd$migrates <- c(0,1)

pr <- predict(mod, newdata=nd, se.fit=T)

data.frame(pr=pr$fit, lower=pr$fit - 1.96*pr$se.fit, 
           upper=pr$fit + 1.96*pr$se.fit,
           mig=c('Does not migrate', 'Migrates')) %>%
  ggplot(aes(x=mig, y=pr)) +
  geom_errorbar(aes(ymin=lower,ymax=upper), width=0.4) +
  geom_point() +
  labs(y='log(H)')  +
  mytheme +
  theme(axis.title.x=element_blank())
```

### Threatened Status

```{r}
nd <- df_temp[rep(1,2),]
nd$threatened <- c(0,1)

pr <- predict(mod, newdata=nd, se.fit=T)

data.frame(pr=pr$fit, lower=pr$fit - 1.96*pr$se.fit, 
           upper=pr$fit + 1.96*pr$se.fit,
           mig=c('Not threatened', 'threatened')) %>%
  ggplot(aes(x=mig, y=pr)) +
  geom_errorbar(aes(ymin=lower,ymax=upper), width=0.4) +
  geom_point() +
  labs(y='log(H)')  +
  mytheme +
  theme(axis.title.x=element_blank())
```

### Mean absolute latitude (from BirdLife distribution maps)

```{r}
lat_seq <- seq(range(dat_het$mean_lat,na.rm=T)[1],range(dat_het$mean_lat,na.rm=T)[2], length.out=1000)

nd <- df_temp
nd <- nd[rep(1,1000),]
nd$mean_lat <- lat_seq
pr <- predict(mod, newdata=nd, se.fit=T)

data.frame(pr=pr$fit, lower=pr$fit - 1.96*pr$se.fit, 
           upper=pr$fit + 1.96*pr$se.fit, mass=actual_seq) %>%
  ggplot(aes(x=lat_seq, y=pr)) +
  geom_ribbon(aes(ymin=lower,ymax=upper), alpha=0.4) +
  geom_line() +
  labs(x='Mean latitude', y='log(H)') +
  mytheme

```


### Area (from ENM)

```{r}
area_seq <- seq(range(dat_het$area,na.rm=T)[1],range(dat_het$area,na.rm=T)[2], length.out=1000)

nd <- df_temp
nd <- nd[rep(1,1000),]
nd$area <- area_seq
pr <- predict(mod, newdata=nd, se.fit=T)

data.frame(pr=pr$fit, lower=pr$fit - 1.96*pr$se.fit, 
           upper=pr$fit + 1.96*pr$se.fit, mass=actual_seq) %>%
  ggplot(aes(x=area_seq, y=pr)) +
  geom_ribbon(aes(ymin=lower,ymax=upper), alpha=0.4) +
  geom_line() +
  labs(x='Area (km2)', y='log(H)') +
  mytheme

```

Heterozygosity With multiple red list categories:

```{r}

modIU <- lm(log(Het) ~ IUCN + scale(mass) + migrates + diet + 
          scale(mean_lat) + scale(area), data=dat_het)

sjPlot::tab_model(modIU)

nd <- df_temp[rep(1,length(levels(dat_het$IUCN))),]
nd$IUCN <- factor(levels(dat_het$IUCN),levels=levels(dat_het$IUCN))

pr <- predict(modIU, newdata=nd, se.fit=T)

data.frame(pr=pr$fit, lower=pr$fit - 1.96*pr$se.fit, 
           upper=pr$fit + 1.96*pr$se.fit,
           IUCN=nd$IUCN) %>%
  ggplot(aes(x=IUCN, y=pr)) +
  geom_errorbar(aes(ymin=lower,ymax=upper), width=0.4) +
  geom_point() +
  labs(y='log(H)')  +
  xlab("IUCN status") +
  mytheme +
  theme(axis.title.x=element_blank())

```




## Effective Population Size

```{r}


ne_long <- nesize %>% gather(key='period', value='ne', pliest:earlyholo)

dat3 <- areas %>%
  mutate(species=dat$Species) %>%
  gather(key='period', value='area', pliest:present) %>%
  left_join(ne_long) %>%
  rename(Species=species) %>%
  left_join(dat_lat) %>%
  filter(period != 'present')
```

```{r}
library(lme4)
library(lmerTest)

mod8 <- lmer(log(ne) ~ scale(area) + scale(mass) + scale(mean_lat) + 
             migrates + threatened + diet +
             (1 + scale(area)|Species), data=dat3)

sjPlot::tab_model(mod8)

```


Subsetting to only Nadachowska species

```{r}

sub_species <- read.table('data2/Nadachowska_species_incl.txt',header=F)$V1

dat_sub <- dat3 %>%
  filter(Species %in% sub_species)

mod7 <- lmer(log(ne) ~ scale(area) + scale(mass) + scale(mean_lat) +
             migrates + threatened + diet +
             (1 + scale(area)|Species), data=dat_sub)

sjPlot::tab_model(mod7)

```

Patterns are similar but weaker

Note I had to exclude a number of species (~14?) from full analysis because they were missing trait covariates, might want to go back and look at your traits database and see if any of those missing values can be added in.

## Another Way of Looking at Area Effect

Uses chi-square/contingency analysis like the bat paper.

A separate analysis is run for three period (PL-LIG, LIG-LGM, LGM-HOLO).
For each period change in effective population size and change in habitat area is coded as either increasing.
Then a chi-square test is done for each period to see if there is a relationship between the two.

```{r}
#pl_igper1 <- 
dat2 <- nechng %>%
  mutate(pl_ig_bin = ifelse(pl_ig >= 0, 'Ne: increasing', 'Ne: decreasing'),
         ig_gm_bin = ifelse(ig_gm >= 0,'Ne: increasing', 'Ne: decreasing'),
         gm_eh_bin = ifelse(gm_eh >= 0, 'Ne: increasing', 'Ne: decreasing')) %>%
  rename(Species=species) %>%
  left_join(dat, by='Species') %>%
  left_join(chng %>% rename(Species=species) %>%
            mutate(
            plig_area_bin=ifelse(pl_ig>=0, 'Area: increasing', 'Area: decreasing'),
            iggm_area_bin=ifelse(ig_gm>=0, 'Area: increasing','Area: decreasing'),
            gmeh_area_bin=ifelse(gm_eh>=0, 'Area: increasing','Area: decreasing'))
            
            ,by='Species') %>%
  select(pl_ig_bin, ig_gm_bin, gm_eh_bin, plig_area_bin, iggm_area_bin, gmeh_area_bin, Species)
```

#### PL-LIG
```{r}



table(dat2$pl_ig_bin, dat2$plig_area_bin)
mosaicplot(table(dat2$pl_ig_bin, dat2$plig_area_bin), color=T)

chisq.test(dat2$pl_ig_bin, dat2$plig_area_bin)
```

##### LIG-LGM

```{r}

table(dat2$ig_gm_bin, dat2$iggm_area_bin)
mosaicplot(table(dat2$ig_gm_bin, dat2$iggm_area_bin), color=T)

chisq.test(dat2$ig_gm_bin, dat2$iggm_area_bin)
```

##### LGM-EHOLO

```{r}


table(dat2$gm_eh_bin, dat2$gmeh_area_bin)
mosaicplot(table(dat2$gm_eh_bin, dat2$gmeh_area_bin), color=T)

chisq.test(dat2$gm_eh_bin, dat2$gmeh_area_bin)
```

None show any relationship between Ne and habitat area...

